# Database Setup Guide

This guide explains how to set up and use PostgreSQL with this application using Alembic migrations.

## Prerequisites

- PostgreSQL 12 or higher installed
- Python 3.12+ with virtual environment activated

## Quick Start

1. **Install Dependencies**
   ```bash
   pip install -r requirements.txt
   ```

2. **Create PostgreSQL Database**
   ```bash
   # Login to PostgreSQL
   psql -U postgres

   # Create database
   CREATE DATABASE hsd;

   # Exit PostgreSQL
   \q
   ```

3. **Configure Environment Variables**

   Copy `.env.example` to `.env` and update the database URL:
   ```bash
   cp .env.example .env
   ```

   Edit `.env` and set your database credentials:
   ```
   DATABASE_URL=postgresql+asyncpg://postgres:your_password@localhost:5432/hsd
   ```

4. **Run Database Migrations**
   ```bash
   alembic upgrade head
   ```

5. **Start the Application**
   ```bash
   python main.py
   ```

## Database Migrations

This project uses **Alembic** for database schema management. Migrations are located in the `alembic/versions/` directory.

### Apply Migrations (Production & Development)

To create tables or apply schema changes:

```bash
alembic upgrade head
```

### Create New Migration

When you modify database models:

```bash
alembic revision --autogenerate -m "Description of changes"
alembic upgrade head
```

### Rollback Migration

To rollback the last migration:

```bash
alembic downgrade -1
```

## Important Notes

- **Migrations Required**: This application uses Alembic for schema management. You MUST run `alembic upgrade head` before starting the app.
- **No Auto-Create**: Tables are NOT automatically created on startup. Use migrations to manage schema changes.
- **Version Control**: All migration files in `alembic/versions/` should be committed to git.

## Database Schema

### Table: `query_history`

| Column | Type | Description |
|--------|------|-------------|
| `id` | Integer (PK) | Auto-incrementing primary key |
| `original_query` | Text | The original user query |
| `formatted_query` | Text | The formatted Google search query |
| `last_run_at` | DateTime | When the query was last executed |
| `created_at` | DateTime | When the record was created |
| `updated_at` | DateTime | When the record was last updated |

## Usage

The application automatically saves all formatted queries to the database when the `/format-query` endpoint is called.

## Troubleshooting

### Connection Issues

If you get connection errors:

1. Verify PostgreSQL is running:
   ```bash
   sudo systemctl status postgresql
   ```

2. Check database exists:
   ```bash
   psql -U postgres -l
   ```

3. Verify credentials in `.env` file

### Migration Issues

If migrations fail:

1. Check current migration status:
   ```bash
   alembic current
   ```

2. View migration history:
   ```bash
   alembic history
   ```

3. Reset database (CAUTION: This deletes all data):
   ```bash
   psql -U postgres -c "DROP DATABASE hsd;"
   psql -U postgres -c "CREATE DATABASE hsd;"
   alembic upgrade head
   ```

## Development Tips

- Set `DATABASE_ECHO=true` in `.env` to see SQL queries in logs
- Use `alembic revision --autogenerate` to automatically detect schema changes
- Always review autogenerated migrations before applying them
